#define ORDER_ORIGIN_FIELD 2
#define PLAYER_NUMBER_FIELD 3
#define ORDER_FORM_START_FIELD 9
#define MESSAGE_HEADER_FIELD 309
#define MESSAGE_LINE1_FIELD 310
#define MESSAGE_LINE2_FIELD 311

#define NO_ORDERS 0
#define PAPER_ORDERS 1  /* orders entered from paper */
#define BBS_ORDERS 2    /* orders entered from bbs */
#define DISK_ORDERS 3	/* orders entered from disk */

#include <conio.h>
#include <ctype.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "lizard.h"
#include "order.h"
#include "map.h"
#include "template.h"

#include "strgfunc.h"
#include "tempfunc.h"

#include "lizgame.h"
#include "lizhex.h"
#include "lizmisc.h"

char player_orders_origin [MAX_PLAYERS + 1];

unsigned int spawn_turn_switch = 0,
	     capture_switch = 0,
	     volcano_dormant_switch = 0,
	     peak_active_switch = 0,
	     world_wrap_switch = 0,
	     victory_points_switch = 0,
	     home_owned_worth = 0,
	     home_victory_points = 0,
	     give_switch  = 0;

char chant_code [NUMBER_CHANTS][5] = { "EYES", "REVE", "SHUN", "MOUL",
				       "COER", "TRAN", "DARK", "FREE",
				       "SUMM", "GATE" };

int main (int argc, char **argv);
void input_order_form (char *filename, int input_player,
		       field_t **order_template,
		       char **order_data [MAX_PLAYERS + 1],
		       field_t **other_bit_template,
		       char **other_bit);
void order_string_into_template (char *order, char *string, int *order_num,
                                 int player, FILE *fptr,
				 field_t **order_template,
				 char **order_data [MAX_PLAYERS + 1],
                                 field_t **other_bit_template,
				 char **other_bit);
void output_order_form (field_t **template, char **data, int *kill_players, FILE *fptr);
int order_num_from_string (char *string);
int order_ditto (unsigned int *field, field_t **template, char **data);
int check_order_format (unsigned int *field, field_t **template, char **data);
int order_skip_to_field (unsigned int *field, field_t **template, char **data);
void show_order_form (void);
void show_other_bit_form (void);

int main (int argc, char *argv[])
{
  FILE *fptr;

  char string [256];

  int kill_players [MAX_PLAYERS + 1];

  unsigned int player = 1,
	       loop,
	       option,
	       field_in,
	       start_field,
	       order_template_fields = 0,
	       other_bit_template_fields = 0;

  field_t **order_template,
	  **other_bit_template;

  char **other_bit,
       **player_orders [MAX_PLAYERS + 1];

  printf ("LIZARDS! Order Entry Utility. %s Last compiled %s.\n\n",
	  VER_STRING, __DATE__);

  if (argc == 6)
  {
    data_path = LzCheckDir(argv[1], 0);
    disk_data_path = (char*)malloc(strlen(argv[2] + 1));
    strcpy (disk_data_path, argv [2]);
    email_data_path = (char*)malloc(strlen(argv[3] + 1));
    strcpy (email_data_path, argv [3]);
    world.turn = atoi (argv [4]);
    game_code = (char*)malloc(strlen(argv[5] + 1));
    strcpy (game_code, argv [5]);
    strupr (game_code);
  } else {
    printf ("FATAL ERROR: Turn and Game Number not specified on command line!\n"
	     "             Command Line Format: EXEFILE data_path disk_data_path email_data_path turn game.\n"
	     "                             e.g. ORDERENT C:\\ A:\\ E:\\ 1 A\n");

    exit (EXIT_FAILURE);
  }

  get_switch_list ();

  get_player_list ();

  if (players_in_game == 0)
  {
    printf ("FATAL ERROR: Game %s has no players.\n", game_code);

    

    exit (EXIT_FAILURE);
  }

  get_spy_list ();

  get_world(&world);

  order_template = load_template ("ORDFORM.TEM", &order_template_fields);
  other_bit_template = load_template ("OTHFORM.TEM", &other_bit_template_fields);

  for (player = 0; player < MAX_PLAYERS + 1; player ++)
    player_orders_origin [player] = NO_ORDERS;

  for (player = 1; player < players_in_game + 1; player ++)
  {
    if ((player_orders [player] = calloc (order_template_fields + 1,
      sizeof (char *))) == '\0')
    {
      printf ("FATAL ERROR: Out of memory for calloc.\n");

      

      exit (EXIT_FAILURE);
    }

    set_field (order_template, player_orders [player], 0, game_code);
    set_field (order_template, player_orders [player], 1, argv [4]);
    set_field (order_template, player_orders [player], 3, itoa (player, string, 10));
    set_field (order_template, player_orders [player], 4, player_name [player]);

    switch (player_output_mode [player])
    {
      case 'D':
	set_field (order_template, player_orders [player], 5, "DISK");
	break;
      case 'B':
	set_field (order_template, player_orders [player], 5, "BBS");
	break;
      default:
	set_field (order_template, player_orders [player], 5, "PAPER");
	break;
    }

    set_field (order_template, player_orders [player], 6, player[player].clan_name);
    set_field (order_template, player_orders [player], 7, player[player].code);
    set_field (order_template, player_orders [player], 8, player_cred [player]);
  }

  if ((other_bit = calloc (other_bit_template_fields + 1,
    sizeof (char *))) == '\0')
  {
    printf ("FATAL ERROR: Out of memory for calloc.\n");

    

    exit (EXIT_FAILURE);
  }

  /* check if there's an already existing (partial?) set of orders. If so,
    load into existing tables to allow editing */

  sprintf (string, "%s%s%03d.%s", data_path, TEXT_ORDS_F, world.turn,
    game_code);

  input_order_form (string, 0, order_template, player_orders,
    other_bit_template, other_bit);

  player = 1;

  start_field = ORDER_FORM_START_FIELD;

  while (player != 0)
  {
    for (loop = player; loop < players_in_game + 1 &&
      strcmp (player_name [loop], "****") == 0; loop ++);

    if (loop != players_in_game + 1)
    {
      player = loop;
    }

    show_order_form ();

    show_template (order_template, player_orders [player]);

    if (player_orders [player][ORDER_ORIGIN_FIELD] != '\0')
      if (player_output_mode [player] !=
	player_orders [player][ORDER_ORIGIN_FIELD][0] &&
	start_field == ORDER_FORM_START_FIELD)
      {
	show_error ("WARNING: PLAYER ORDERS NOT FROM SPECIFIED SOURCE");
      }

    switch (enter_template (order_template, player_orders [player], start_field,
      &field_in, check_order_format, order_ditto, order_skip_to_field))
    {
      case ERASE_KEY:
	clear_error ();

	show_error ("SELECT: B=LOAD BBS, D=LOAD DISK, E=ERASE? ");

	option = toupper (getch ());

	switch (option)
	{
	  case 'B':
	    /* look for bbs order files in email directory */

	    clear_error ();

	    /* look for BBS order files in directory */

	    sprintf (string, "%sDOR%02d%03d.%s", email_data_path, player,
	      world.turn, game_code);

	    if ((fptr = fopen (string, "rt")) != '\0')
	    {
	      fclose (fptr);

	      show_error ("SURE YOU WANT TO LOAD BBS ORDERS (Y/N)?");

	      option = toupper (getch ());

	      if (option == 'Y')
	      {
		/* loading bbs orders for player */

		input_order_form (string, player, order_template,
		  player_orders, other_bit_template, other_bit);

		player_orders_origin [player] = BBS_ORDERS;
		set_field (order_template, player_orders [player], ORDER_ORIGIN_FIELD, "BBS");
	      } else {
		show_error ("NO BBS ORDERS LOADED FOR PLAYER.");
	      }
	    } else {
	      sprintf (string, "NO BBS ORDERS FOUND FOR PLAYER IN %s, PRESS SPACE.",
		email_data_path);

	      show_error (string);

	      
	    }

	    break;
	  case 'D':
	    clear_error ();

	    sprintf (string, "Insert disk for %s, Player %02d, Game %s into %s.",
	      player_name [player], player, game_code, disk_data_path);

	    show_error (string);

	    

	    /* look for disk order files in drive */

	    sprintf (string, "%sDOR%02d%03d.%s", disk_data_path, player,
	      world.turn, game_code);

	    if ((fptr = fopen (string, "rt")) != '\0')
	    {
	      fclose (fptr);

	      show_error ("SURE YOU WANT TO LOAD DISK ORDERS (Y/N)?");

	      option = toupper (getch ());

	      if (option == 'Y')
	      {
		/* loading disk orders for player */

		input_order_form (string, player, order_template,
		  player_orders, other_bit_template, other_bit);

		player_orders_origin [player] = DISK_ORDERS;
		set_field (order_template, player_orders [player], ORDER_ORIGIN_FIELD, "DISK");
	      } else {
		show_error ("NO DIS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       