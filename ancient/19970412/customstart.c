#define CUSTSTAR_LOG_FILE "STARTLOG"

#include <ctype.h>
#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <time.h>

#include "lizard.h"
#include "map.h"
#include "custom.h"

#include "strgfunc.h"

#include "lizgame.h"
#include "lizhex.h"
#include "lizmisc.h"

#define PLAYER_CODE "PLAYER"
#define STARTUP_CODE "STARTUP"
#define TEMPLATE_CODE "TEMPLATE"
#define HOME_HEX_CODE "HOME"

#define CODE_LENGTH 4

#define RUIN_CODE "RUI"
#define PLAIN_CODE "PLA"
#define SWAMP_CODE "SWA"
#define SCRUB_CODE "SCR"
#define FERTILE_CODE "FER"
#define PEAK_CODE "PEA"
#define VOLCANO_CODE "VOL"
#define TEMPLE_CODE "TEM"
#define CURSED_CODE "CUR"
#define WHIRLPOOL_CODE "WHI"
#define WATER_CODE "WAT"

#define TERRAIN_TYPES 16

#define RED_DEN_CODE "RED"
#define YELLOW_DEN_CODE "YEL"
#define GREEN_DEN_CODE "GRN"
#define GREY_DEN_CODE "GRY"
#define BLACK_DEN_CODE "BLK"

#define RED_LIZARD_CODE "RED"
#define YELLOW_LIZARD_CODE "YEL"
#define GREEN_LIZARD_CODE "GRN"
#define GREY_LIZARD_CODE "GRY"
#define BLACK_LIZARD_CODE "BLK"

const unsigned char template_hexes [TEMPLATES + 1] =
    { 0, TEMPLATE1_HEX, TEMPLATE2_HEX, TEMPLATE3_HEX, TEMPLATE4_HEX,
      TEMPLATE5_HEX, TEMPLATE6_HEX, TEMPLATE7_HEX, TEMPLATE8_HEX };

const unsigned char template_cost [TEMPLATES + 1] =
    { 0, TEMPLATE1_COST, TEMPLATE2_COST, TEMPLATE3_COST, TEMPLATE4_COST,
      TEMPLATE5_COST, TEMPLATE6_COST, TEMPLATE7_COST, TEMPLATE8_COST };

const char template_hex_x_offset [TEMPLATES + 1][MAX_TEMPLATE_HEX] =
  {{0},
   {-1,-1,0,0,0,1,1},
   {-1,-1,-1,0,0,0,1,1,1},
   {-2,-1,-1,-1,0,0,0,1,1,1,2},
   {-2,-2,-1,-1,-1,0,0,0,0,1,1,1,2,2},
   {-1,-1,-1,-1,-1,0,0,0,0,0,0,1,1,1,1,1},
   {-3,-3,-2,-2,-2,-1,-1,0,0,0,1,1,2,2,2,3,3},
   {-2,-2,-2,-1,-1,-1,-1,0,0,0,0,0,1,1,1,1,2,2,2},
   {-3,-3,-3,-2,-2,-2,-2,-1,-1,-1,-1,0,0,0,0,1,1,1,1,2,2,2}};

const char template_hex_y_offset [TEMPLATES + 1][MAX_TEMPLATE_HEX] =
  {{0},
   {-1,0,-1,0,1,-1,0},
   {0,1,2,0,1,2,-1,0,1},
   {1,-1,0,1,-1,0,1,-2,-1,0,-1},
   {-1,0,-2,-1,0,-2,-1,0,1,-2,-1,0,-1,0},
   {-2,-1,0,1,2,-2,-1,0,1,2,3,-2,-1,0,1,2},
   {-1,0,-1,0,1,-1,0,-1,0,1,-1,0,-1,0,1,-1,0},
   {-1,0,1,-2,-1,0,1,-2,-1,0,1,2,-2,-1,0,1,-1,0,1},
   {-2,-1,0,-2,-1,0,1,-2,-1,0,1,-1,0,1,2,-1,0,1,2,0,1,2}};

int grid_x,
    grid_y,
    grid_size;
int player_grid[MAX_PLAYERS+1];

int main (int argc, char **argv);
void build_startup (int, FILE *template_fptr, FILE *log_fptr);
void lay_template (unsigned int player, unsigned int tmpl, hex_t *hexes,
                   FILE *log_fptr);
void build_hex (unsigned int *points, hex_t *hex, char *string);

int main (int argc, char **argv)
{
  FILE *order_fptr,
       *template_fptr,
       *log_fptr;

  char filename [80],
       text_string [256],
       tok_string [256];

  int p,
    startup,
    loop;


  randomize ();

  show_title ();

  printf ("LIZARDS! Custom Startup Program. %s Last compiled %s.\n\n",
          VER_STRING, __DATE__);

  if (argc == 3)
  {
    data_path = LzCheckDir(argv[1], 0);
    game_code = (char*)malloc(strlen(argv[2]) + 1);
    strcpy (game_code, argv[2]);
    strupr (game_code);
  }
  else
    {
    printf ("FATAL ERROR: Turn and Game Number not specified on command line!\r\n"
	     "             Command Line Format: EXEFILE data_path game.\r\n"
	     "             e.g. CUSTSTAR C:\\ A\r\n");

    exit (EXIT_FAILURE);
  }

  get_world (&world);

  get_player_list ();

  if (players_in_game == 0)
  {
    printf ("FATAL ERROR: Game %s has no players.\n", game_code);
    exit (EXIT_FAILURE);
  }

  grid_size = (int)(sqrt (players_in_game));

  if (grid_size * grid_size < players_in_game) grid_size ++;

  grid_x = world.x / grid_size;
  grid_y = world.y / grid_size;

  for (loop = 0; loop < players_in_game + 1; loop ++)
  {
    player[loop].home_den = 0;
    player_grid [loop] = -1;
  }

  sprintf (filename, "%s%s.%s", data_path, CUSTSTAR_LOG_FILE, game_code);

  if ((log_fptr = fopen (filename, "wt")) == NULL)
  {
    printf ("FATAL ERROR: Unable to write to %s file. \n", filename);
    exit (EXIT_FAILURE);
  }

  fprintf (log_fptr, "\nCustom Startup Log File for LIZARDS! Game %s.\n\n", game_code);

  sprintf (filename, "%s%s.%s", data_path, TEXT_START_ORDS_F, game_code);

  if ((order_fptr = fopen (filename, "rt")) == NULL)
  {
    printf ("FATAL ERROR: Unable to read %s file. \n", filename);
    exit (EXIT_FAILURE);
  }

  /* read file until we get to a new 'PLAYER' header */

  while (fgets (text_string, 255, order_fptr) != NULL)
  {
    if (text_string [strlen (text_string) - 1] == '\n')
      text_string [strlen (text_string) - 1] = '\0';

    strupr (text_string);

    strtoken (tok_string, text_string, " ");

    if (strcmp (tok_string, PLAYER_CODE) == 0)
    {
      /* found player header, now find and validate player code */

      p = atoi (text_string);

      if (p == 0 || p > players_in_game)
      {
        fprintf (log_fptr, "FATAL ERROR: Invalid player number in %s file.\n",
          filename);

        printf ("FATAL ERROR: Invalid player number in %s file.\n",
          filename);
	exit (EXIT_FAILURE);
      }

      /* check player hasn't already started */

      if (player[p].home_den != 0)
      {
        fprintf (log_fptr, "FATAL ERROR: Attempted to re-start player %d.\n",
          p);

        printf ("FATAL ERROR: Attempted to re-start player %d. \n",
          p);
	exit (EXIT_FAILURE);
      }

      /* next line should be STARTUP */

      if (fgets (text_string, 255, order_fptr) == NULL)
      {
        fprintf (log_fptr, "FATAL ERROR: Unexpected end of file %s.\n", filename);

        printf ("FATAL ERROR: Unexpected end of file %s. \n", filename);
	exit (EXIT_FAILURE);
      }

      if (text_string [strlen (text_string) - 1] == '\n')
	text_string [strlen (text_string) - 1] = '\0';

      strupr (text_string);

      strtoken (tok_string, text_string, " ");

      if (strcmp (tok_string, STARTUP_CODE) == 0)
      {
	/* find startup */

	if (!isdigit (text_string [0]) && text_string [0] != 'C')
	{
          fprintf (log_fptr, "FATAL ERROR: Player %d selected invalid STARTUP.\n",
            p);

          printf ("FATAL ERROR: Player %d selected invalid STARTUP. \n",
            p);
	  exit (EXIT_FAILURE);
	}

	startup = atoi (text_string);

	if (startup > VALID_STARTUP)
        {
          fprintf (log_fptr, "FATAL ERROR: Player %d selected invalid STARTUP.\n",
            p);

          printf ("FATAL ERROR: Player %d selected invalid STARTUP. \n",
            p);
	  exit (EXIT_FAILURE);
	}

	switch (startup)
	{
	  case CUSTOM_STARTUP:
	    build_startup (p, order_fptr, log_fptr);

	    break;
	  case 1:
	  case 2:
	  case 3:
	  case 4:
	    sprintf (filename, "CUST%d.MAP", startup);

	    if ((template_fptr = fopen (filename, "rt")) == NULL)
            {
              printf ("FATAL ERROR: Unable to read %s file. \n", filename);
	      exit (EXIT_FAILURE);
	    }

	    build_startup (p, template_fptr, log_fptr);

	    fclose (template_fptr);

	    break;
	  default:
	    if (startup > VALID_STARTUP)
            {
              fprintf (log_fptr, "FATAL ERROR: Player %d selected invalid STARTUP.\n",
                p);

              printf ("FATAL ERROR: Player %d selected invalid STARTUP. \n",
                p);
	      exit (EXIT_FAILURE);
	    }
	}
      } else {
        fprintf (log_fptr, "FATAL ERROR: Player %d selected invalid STARTUP.\n",
          p);

        printf ("FATAL ERROR: Player %d unspecified STARTUP. \n",
          p);
	exit (EXIT_FAILURE);
      }
    }
  }

  fclose (order_fptr);

  fprintf (log_fptr, "\nEND OF CUSTOM STARTUP LOG FILE\n");

  fclose (log_fptr);

  put_home_den_status ();

  printf ("Finished!\n");

  return (EXIT_SUCCESS);
}

/* ----------------------------------------------------------------------
--
-- BuildStartup
--
---------------------------------------------------------------------- */

void build_startup (int p, FILE *template_fptr, FILE *log_fptr)
{
  FILE *default_fptr;

  char text_string [256],
       tok_string [256],
       filename [256];

  int home_hex;

  int tmpl,
    player_points = 0,
    present_hex = 0,
    loop,
    loop_two,
    fertiles;

  hex_t empty_hex,
	new_hex;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         